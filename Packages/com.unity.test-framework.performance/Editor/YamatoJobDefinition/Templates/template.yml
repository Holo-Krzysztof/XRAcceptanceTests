version: <<UNITY_VERSION>>
  
filename: <<FILENAME>>

tests-project: <<TESTS_LOCATION>>

platforms:
  - name: OSX
    agent:
      type: Unity::VM::osx
      image: 'buildfarm/mac:stable'
      flavor: m1.mac
      flavor-run: m1.mac
    cli: ${VERSION}
    utr: utr
    utr-platform: StandaloneOSX
  - name: Windows
    agent:
      type: Unity::VM
      image: 'sdet/gamecode_win10:latest'
      flavor: b1.xlarge
      flavor-run: b1.large
    cli: '%VERSION%'
    utr: utr.bat
    utr-platform: StandaloneWindows64
  - name: PS4
    agent:
      type: Unity::console::ps4
      image: 'sdet/gamecode-ps4:latest'
      flavor: b1.xlarge
      flavor-run: b1.large
    cli: '%VERSION% -c ps4'
    utr: utr.bat
    utr-platform: XBoxOne
  - name: Xbox
    agent:
      type: Unity::console::xbox
      image: 'sdet/gamecode-xboxone:stable'
      flavor: b1.xlarge
      flavor-run: b1.large
    cli: '%VERSION% -c xboxone'
    utr: utr.bat
    utr-platform: ps4
---

{% assign targetPlatforms = "<<TARGET_PLATFORMS>>" | split: " " %}

{% assign modes = "<<TARGET_MODES>>" | split: " " %}

{% for targetPlatform in targetPlatforms %}
  {% for platform in platforms %}
    {% if platform.name == targetPlatform %}
      {% for mode in modes %}
        {% if mode == 'playmode' %}
Build_Player_With_Performance_Tests_{{platform.name}}:
  name: Build Players with Performance tests {{platform.name}}
  agent:
    type: {{platform.agent.type}}
    image: {{platform.agent.image}}
    flavor: {{platform.agent.flavor}}
  variables:
    VERSION: {{version}}
  commands:
    - pip install unity-downloader-cli --extra-index-url https://artifactory.internal.unity3d.com/api/pypi/common-python/simple --upgrade
    - unity-downloader-cli -c Editor -u {{platform.cli}} --wait
    - curl -s https://artifactory.internal.unity3d.com/core-automation/tools/utr-standalone/{{platform.utr}} --output {{platform.utr}}
    {% if platform.name == 'OSX' %}
    - chmod +x ./utr
    {% endif %}
    - ./utr --suite=playmode --platform={{platform.utr-platform}} --editor-location=.Editor --category=Performance --testproject={{tests-project}} --player-save-path=build/players --artifacts_path=build/logs --build-only
  artifacts:
    players:
      paths:
        - "build/players/**"
    logs:
      paths:
        - "build/logs/**"

Run_Player_With_Performance_Tests_{{platform.name}}:
  name: Run playmode performances tests {{platform.name}}
  agent:
    type: {{platform.agent.type}}
    image: {{platform.agent.image}}
    flavor: {{platform.agent.flavor-run}}
  variables:
    VERSION: {{version}}
  dependencies:
    - .yamato/{{filename}}#Build_Player_With_Performance_Tests_{{platform.name}}
  commands:
  {% if platform.name == 'OSX' %}
    - curl -s https://artifactory.internal.unity3d.com/core-automation/tools/utr-standalone/utr --output utr
    - chmod +x ./utr
    - ./utr --suite=playmode --platform=StandaloneOSX --report-performance-data --performance-project-id=ONE-CLICK-PERFORMANCE --player-load-path=build/players --artifacts_path=build/test-results --player-connection-ip=auto
  {% endif %}
  {% if platform.name == 'Windows' %}
    - curl -s https://artifactory.internal.unity3d.com/core-automation/tools/utr-standalone/utr.bat --output utr.bat
    - ./utr --suite=playmode --platform=StandaloneWindows64 --report-performance-data --performance-project-id=ONE-CLICK-PERFORMANCE --player-load-path=build/players --artifacts_path=build/test-results --player-connection-ip=auto
  {% endif %}
  {% if platform.name == 'Xbox' %}
    - NetSh Advfirewall set allprofiles state off
    - curl -s https://artifactory.internal.unity3d.com/core-automation/tools/utr-standalone/utr.bat --output utr.bat
    - ./utr --suite=playmode --platform=XBoxOne --report-performance-data --performance-project-id=ONE-CLICK-PERFORMANCE --player-load-path=build/players --artifacts_path=build/test-results --player-connection-ip=%BOKKEN_HOST_IP% --device-ip=%BOKKEN_DEVICE_IP%
  {% endif %}
  {% if platform.name == 'PS4' %}
    - NetSh Advfirewall set allprofiles state off
    - orbis-ctrl add %BOKKEN_DEVICE_IP%
    - curl -s https://artifactory.internal.unity3d.com/core-automation/tools/utr-standalone/utr.bat --output utr.bat
    - ./utr --suite=playmode --platform=ps4 --report-performance-data --performance-project-id=ONE-CLICK-PERFORMANCE --player-load-path=build/players --artifacts_path=build/test-results --player-connection-ip=%BOKKEN_HOST_IP%
  {% endif %}
  artifacts:
    logs:
      paths:
        - "build/test-results/**"
        {% endif %}
        {% if mode == 'editor' %}
Run_Editor_With_Performance_Tests_{{platform.name}}:
  name: Run Editor performances tests {{platform.name}}
  agent:
    type: {{platform.agent.type}}
    image: {{platform.agent.image}}
    flavor: {{platform.agent.flavor-run}}
  variables:
    VERSION: {{version}}
  commands:
    - pip install unity-downloader-cli --extra-index-url https://artifactory.internal.unity3d.com/api/pypi/common-python/simple --upgrade
    - unity-downloader-cli -c Editor -u {{platform.cli}} --wait
  {% if platform.name == 'OSX' %}
    - curl -s https://artifactory.internal.unity3d.com/core-automation/tools/utr-standalone/utr --output utr
    - chmod +x ./utr
    - ./utr --suite=editor --platform=StandaloneOSX --editor-location=.Editor --category=Performance --testproject={{tests-project}} --report-performance-data --performance-project-id=ONE-CLICK-PERFORMANCE --artifacts_path=build/test-results --player-connection-ip=auto
  {% endif %}
  {% if platform.name == 'Windows' %}
    - curl -s https://artifactory.internal.unity3d.com/core-automation/tools/utr-standalone/utr.bat --output utr.bat
    - ./utr --suite=editor --platform=StandaloneWindows64 --editor-location=.Editor --category=Performance --testproject={{tests-project}} --report-performance-data --performance-project-id=ONE-CLICK-PERFORMANCE --artifacts_path=build/test-results --player-connection-ip=auto
  {% endif %}
  {% if platform.name == 'Xbox' %}
    - NetSh Advfirewall set allprofiles state off
    - curl -s https://artifactory.internal.unity3d.com/core-automation/tools/utr-standalone/utr.bat --output utr.bat
    - ./utr --suite=editor --platform=XBoxOne --editor-location=.Editor --category=Performance --testproject={{tests-project}} --report-performance-data --performance-project-id=ONE-CLICK-PERFORMANCE --artifacts_path=build/test-results --player-connection-ip=%BOKKEN_HOST_IP% --device-ip=%BOKKEN_DEVICE_IP%
  {% endif %}
  {% if platform.name == 'PS4' %}
    - NetSh Advfirewall set allprofiles state off
    - orbis-ctrl add %BOKKEN_DEVICE_IP%
    - curl -s https://artifactory.internal.unity3d.com/core-automation/tools/utr-standalone/utr.bat --output utr.bat
    - ./utr --suite=editor --platform=ps4 --editor-location=.Editor --category=Performance --testproject={{tests-project}} --report-performance-data --performance-project-id=ONE-CLICK-PERFORMANCE --artifacts_path=build/test-results --player-connection-ip=%BOKKEN_HOST_IP%
  {% endif %}
  artifacts:
    logs:
      paths:
        - "build/test-results/**"
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endfor %}
{% endfor %}

